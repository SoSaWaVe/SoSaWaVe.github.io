<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>debug tg webapp</title>
  </head>
  <body>
    <div id="greeting">Здравствуйте, гость!</div>
    <pre id="log" style="white-space:pre-wrap; font-size:12px; color:#333"></pre>

    <script>
    (function(){
      function dbg(s){
        const lg = document.getElementById('log');
        if(lg) lg.textContent += s + '\n';
      }

      function setGreeting(name){
        const el = document.getElementById('greeting');
        if(!el){ dbg('Ошибка: нет элемента #greeting'); return; }
        el.textContent = name ? `Здравствуйте, ${name}!` : 'Здравствуйте, гость!';
      }

      function init(){
        dbg('DOM ready');
        const tg = window.Telegram && window.Telegram.WebApp;
        if(!tg){
          dbg('window.Telegram.WebApp отсутствует — страница открыта НЕ как WebApp (или web.telegram.org).');
          setGreeting(null);
          return;
        }

        try {
          tg.ready();
          if(typeof tg.expand === 'function') tg.expand();
        } catch(e){
          dbg('tg.ready/expand выбросил ошибку: ' + e);
        }

        dbg('initData (string): ' + (tg.initData || '(пусто)'));
        dbg('initDataUnsafe (object): ' + JSON.stringify(tg.initDataUnsafe || null));

        const user = tg.initDataUnsafe && tg.initDataUnsafe.user;
        if(user){
          dbg('User найден: id=' + user.id + ', name=' + (user.first_name || '(нет имени)'));
          setGreeting(user.first_name);
        } else {
          dbg('User === undefined (tg.initDataUnsafe.user пустой).');
          setGreeting(null);
        }
      }

      if(document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', init);
      } else init();
    })();
    </script>
  </body>
</html>

